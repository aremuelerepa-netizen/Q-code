<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q-Code | Global Queue Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-primary: #10b981;
            --brand-dark: #0f172a;
            --brand-accent: #3b82f6;
            --bg-main: #f8fafc;
            --white: #ffffff;
            --text-heading: #1e293b;
            --text-body: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #cbd5e1;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-shell {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            background: var(--bg-main);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        @media (min-width: 1024px) {
            .app-shell {
                max-height: 90vh;
                margin-top: 5vh;
                border-radius: 24px;
            }
        }

        header {
            padding: 16px 24px;
            background: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--brand-dark);
            letter-spacing: -1px;
        }

        .logo span {
            color: var(--brand-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-pill {
            background: var(--bg-main);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-body);
            border: 1px solid var(--border);
            font-weight: 600;
        }

        /* --- LOGOUT BUTTON DESIGN --- */
        .btn-logout {
            background: transparent;
            color: var(--text-body);
            border: 1px solid var(--border);
            padding: 6px 14px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-logout:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            padding-bottom: 100px;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: #ffffff;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .queue-item {
            background: #ffffff;
            padding: 16px;
            border-radius: 20px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-left: 5px solid var(--brand-primary);
            transition: transform 0.2s;
        }

        .status-badge {
            font-size: 0.6rem;
            font-weight: 800;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 6px;
            background: #e0f2fe;
            color: var(--brand-accent);
            display: inline-block;
            margin-bottom: 5px;
        }

        .time-box {
            background: #f0fdf4;
            color: var(--brand-primary);
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-block;
            margin: 8px 0;
        }

        .btn-small {
            background: none;
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 0.7rem;
            cursor: pointer;
            font-weight: 700;
        }

        .btn-action {
            background: var(--brand-dark);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 14px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .confirm-box {
            background: #ffffff;
            width: 85%;
            max-width: 340px;
            padding: 30px;
            border-radius: 32px;
            text-align: center;
        }

        nav {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: #ffffff;
            display: flex;
            justify-content: space-around;
            padding: 12px 0 28px;
            border-top: 1px solid var(--border);
            z-index: 10;
        }

        .nav-link {
            text-align: center;
            color: var(--text-body);
            cursor: pointer;
            flex: 1;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .nav-link.active {
            color: var(--brand-primary);
        }

        .chat-drawer {
            position: absolute;
            bottom: -100%;
            left: 0;
            width: 100%;
            height: 75%;
            background: #ffffff;
            z-index: 200;
            border-radius: 32px 32px 0 0;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
            transition: 0.4s;
            display: flex;
            flex-direction: column;
        }

        .chat-drawer.open {
            bottom: 0;
        }
    </style>
</head>

<body>

    <div class="app-shell">
        <header>
            <div class="logo">Q-<span>Code</span></div>
            <div class="header-right">
                <div class="user-pill" id="user-display-name">Loading...</div>
                <button class="btn-logout" onclick="handleLogout()">Logout</button>
            </div>
        </header>

        <div class="content">
            <div id="home" class="page active">
                <div class="card">
                    <h2 style="font-size: 1.1rem; margin-bottom: 10px;">Join a Service</h2>
                    <input type="text" id="serviceCode" placeholder="Enter Code (e.g. UCH01)" maxlength="5"
                        style="width: 100%; border: 1px solid var(--border); padding: 10px; border-radius: 10px; margin-bottom:10px; outline:none;">
                    <button class="btn-action" onclick="checkCode()">Join Queue</button>
                </div>
                <h3 style="font-size: 0.9rem; margin-bottom: 12px;">My Appointments</h3>
                <div id="queue-container">
                    <p id="empty-msg"
                        style="text-align:center; color:var(--text-body); font-size:0.8rem; margin-top:20px;">No active
                        queues.</p>
                </div>
            </div>

            <div id="nearme" class="page">
                <h2 style="margin-bottom: 16px;">Nearby Services</h2>
                <div id="nearby-container">
                    <div class="near-me-item"
                        style="background:#fff; padding:16px; border-radius:20px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border);">
                        <div><strong>UCH Hospital</strong><br><small>0.8km away</small></div>
                        <button class="btn-small" style="background:var(--brand-dark); color:white;"
                            onclick="checkCode('UCH01')">Join</button>
                    </div>
                </div>
            </div>

            <div id="notifications" class="page">
                <h2 style="margin-bottom: 16px;">Announcements</h2>
                <div id="notif-stream"></div>
            </div>
        </div>

        <nav>
            <div class="nav-link active" onclick="showPage('home', this)">
                <svg style="width:20px; height:20px; display:block; margin:0 auto 4px;" fill="currentColor"
                    viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                </svg>
                <span>Home</span>
            </div>
            <div class="nav-link" onclick="showPage('nearme', this)">
                <svg style="width:20px; height:20px; display:block; margin:0 auto 4px;" fill="currentColor"
                    viewBox="0 0 24 24">
                    <path
                        d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
                </svg>
                <span>Near Me</span>
            </div>
            <div class="nav-link" onclick="showPage('notifications', this)">
                <svg style="width:20px; height:20px; display:block; margin:0 auto 4px;" fill="currentColor"
                    viewBox="0 0 24 24">
                    <path
                        d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z" />
                </svg>
                <span>Alerts</span>
            </div>
        </nav>
    </div>

    <div class="overlay" id="confirmModal">
        <div class="confirm-box">
            <h3 id="confirmTitle">Are you sure?</h3>
            <p id="confirmDesc" style="font-size:0.85rem; color:var(--text-body); margin: 15px 0 25px;">This cannot be
                undone.</p>
            <div style="display:flex; gap:10px;">
                <button class="btn-small" onclick="closeModal('confirmModal')"
                    style="flex:1; padding:12px;">Cancel</button>
                <button id="confirmActionBtn" class="btn-action"
                    style="flex:1; background:var(--danger); padding:12px;">Confirm</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="detailsModal">
        <div class="confirm-box">
            <h3 id="modalTitle">Join Queue</h3>
            <div id="custom-fields" style="margin:20px 0;"></div>
            <button class="btn-action" id="finalizeBtn" onclick="finalizeJoin()">Confirm & Join</button>
        </div>
    </div>

    <script>
        const API_BASE = "https://your-backend-api.com";
        let activeOrg = null;

        window.onload = async () => {
            await fetchUserData();
            await fetchActiveQueues();
        };

        async function fetchUserData() {
            try {
                const res = await fetch(`${API_BASE}/api/user-profile`);
                const data = await res.json();
                document.getElementById('user-display-name').innerText = data.name || "Guest User";
            } catch (e) {
                document.getElementById('user-display-name').innerText = "Guest User";
            }
        }

        async function fetchActiveQueues() {
            try {
                const res = await fetch(`${API_BASE}/api/my-queues`);
                const queues = await res.json();
                const container = document.getElementById('queue-container');
                container.innerHTML = queues.length ? '' : '<p id="empty-msg" style="text-align:center; color:var(--text-body); font-size:0.8rem; margin-top:20px;">No active queues.</p>';
                queues.forEach(q => renderQueueCard(q));
            } catch (e) { console.error("Queue fetch failed"); }
        }

        // --- 1. ALREADY JOINED LOGIC ---
        async function checkCode(manualCode = null) {
            const codeInput = document.getElementById('serviceCode');
            const code = (manualCode || codeInput.value).toUpperCase();

            if (!code) return;

            // Check if user is already in this specific queue
            const existingQueues = document.querySelectorAll('.queue-item');
            let isAlreadyJoined = false;

            existingQueues.forEach(card => {
                if (card.dataset.code === code) isAlreadyJoined = true;
            });

            if (isAlreadyJoined) {
                alert("You have already joined this queue!");
                codeInput.value = '';
                return;
            }

            try {
                // Simulate backend verification of the service code
                const res = await fetch(`${API_BASE}/api/verify-service?code=${code}`);
                activeOrg = await res.json();

                document.getElementById('custom-fields').innerHTML = `
                    <label style="display:block; text-align:left; font-size:0.8rem; margin-bottom:5px;">Phone Number</label>
                    <input type="text" id="phoneInput" value="${activeOrg.userPhone || ''}" 
                           style="width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); outline:none;" placeholder="080...">
                `;
                document.getElementById('modalTitle').innerText = activeOrg.name;
                document.getElementById('detailsModal').style.display = 'flex';
                codeInput.value = '';
            } catch (e) { alert("Invalid Service Code"); }
        }

        async function finalizeJoin() {
            const phone = document.getElementById('phoneInput').value;
            const btn = document.getElementById('finalizeBtn');
            btn.innerText = "Joining...";

            try {
                const res = await fetch(`${API_BASE}/api/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serviceCode: activeOrg.code, phone: phone })
                });
                const newEntry = await res.json();
                renderQueueCard(newEntry);
                closeModal('detailsModal');
            } catch (e) { alert("Error joining queue"); }
            btn.innerText = "Confirm & Join";
        }

        function renderQueueCard(data) {
            if (document.getElementById('empty-msg')) document.getElementById('empty-msg').remove();
            const container = document.getElementById('queue-container');
            const card = document.createElement('div');
            card.className = 'queue-item';
            card.id = data.id;
            card.dataset.code = data.serviceCode; // Store code for validation

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div>
                        <span class="status-badge">${data.status}</span><br>
                        <strong>${data.orgName}</strong>
                    </div>
                    <button style="border:none; color:var(--danger); background:none; font-weight:800; font-size:0.6rem; cursor:pointer;" onclick="triggerConfirm('remove', '${data.id}')">REMOVE</button>
                </div>
                <div class="pos-num" style="font-size:1.4rem; font-weight:800; color:var(--brand-primary); margin:5px 0;">#${data.position}</div>
                <div class="time-box">Turn: ${data.estimatedTime}</div>
            `;
            container.prepend(card);
        }

        function triggerConfirm(type, id) {
            const modal = document.getElementById('confirmModal');
            const btn = document.getElementById('confirmActionBtn');
            modal.style.display = 'flex';
            btn.onclick = async () => {
                // Handle remove logic
                document.getElementById(id).remove();
                closeModal('confirmModal');
            };
        }

        function showPage(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            el.classList.add('active');
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function handleLogout() {
            // Simplified logout for demo
            if (confirm("Are you sure you want to logout?")) {
                window.location.href = 'login.html';
            }
        }
    </script>
</body>

</html>